<!-- build time:Mon Aug 09 2021 10:52:50 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next muse use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-bounce.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.jpg?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Server_Programming,Inter-Process Communication,"><meta property="og:type" content="article"><meta property="og:title" content="Linux 进程间通信"><meta property="og:url" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/index.html"><meta property="og:site_name" content="CongZ&#39;s Blog"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F_%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1_error.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E6%97%A0%E5%90%8D%E7%AE%A1%E9%81%93%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E8%AF%BB%E9%98%BB%E5%A1%9E.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E9%98%BB%E5%A1%9E_%E7%9D%A1%E7%9C%A0%E7%8A%B6%E6%80%81.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E5%86%99%E9%98%BB%E5%A1%9E.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E5%86%99%E9%98%BB%E5%A1%9E_%E7%9D%A1%E7%9C%A0%E7%8A%B6%E6%80%81.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E7%AE%A1%E9%81%93_%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E5%BC%80%E5%90%AFfirst.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/first_after_second.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/second.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/kill%E6%93%8D%E4%BD%9C.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/image-20210423171228323.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/image-20210423171719834.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/image-20210423171538416.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/image-20210423171817097.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_02.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_05.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_03.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_04.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_05.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_06.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_07.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_08.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/alarm%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/alarm_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/pause%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/pause_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/pause_02.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_02.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_03.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_04.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_05.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_06.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_07.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_08.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_09.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_10.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/IPC%E5%AF%B9%E8%B1%A1.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/IPC%E4%B8%8EIO%E5%AF%B9%E6%AF%94.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmget%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmget_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmget_02.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmget_03.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmat01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmat02.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmdt_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmctl_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmctl_02.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmctl_03.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmctl_04.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shm_server.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shm_client.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E6%B6%88%E6%81%AF%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgget%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgget_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgctl%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgctl_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgsnd%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgrcv%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgrcv_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgrcv_02.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgwrite_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgread_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgserver.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgclient.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E4%BF%A1%E5%8F%B7%E7%81%AF%E7%BB%93%E6%9E%84.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semget%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semget_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semctl%E5%87%BD%E6%95%B0.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semctl_setval.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semctl.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/posix_01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/posix_02.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/posix_03.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semop%E5%87%BD%E6%95%B01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semop%E5%87%BD%E6%95%B02.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/sem_posix.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/sem_pv01.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/sem_pv02.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/sem_pv03.png"><meta property="og:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/IPC%E6%B5%81%E7%A8%8B%E5%9B%BE.png"><meta property="article:published_time" content="2021-05-05T08:56:42.000Z"><meta property="article:modified_time" content="2021-06-22T09:10:09.110Z"><meta property="article:author" content="从之丶"><meta property="article:tag" content="Server_Programming"><meta property="article:tag" content="Inter-Process Communication"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://czgitaccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F_%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1_error.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:"ture",onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://czGitAccount.github.io/Server_Programming/Linux进程间通信/"><title>Linux 进程间通信 | CongZ's Blog</title><meta name="generator" content="Hexo 4.2.0"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">CongZ's Blog</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">择其善者而从之，其不善者而改之 !</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://czGitAccount.github.io/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="从之丶"><meta itemprop="description" content=""><meta itemprop="image" content="/images/logo.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="CongZ's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Linux 进程间通信</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-05-05T16:56:42+08:00">2021-05-05 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Server-Programming/" itemprop="url" rel="index"><span itemprop="name">Server_Programming</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">8.9k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">44</span></div></div></header><div class="post-body" itemprop="articleBody"><div class="out-img-topic"><img src="/Server_Programming/Linux进程间通信/艾玛沃特森.jpg" class="img-topic"></div><div class="post-button text-center"><div>艾玛·沃特森</div></div><a id="more"></a><h3 id="一、进程通信概述"><a class="header-anchor" href="#一、进程通信概述">¶</a>一、进程通信概述</h3><h4 id="1-进程通信、线程通信"><a class="header-anchor" href="#1-进程通信、线程通信">¶</a>1. 进程通信、线程通信</h4><p>进程通信：在用户空间实现进程通信**<font color="FF0000">不可能</font>**，需要通过 Linux 内核通信</p><p>线程通信：可以在用户空间实现，通过<strong>全局变量</strong>即可</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> process_inter = <span class="number">0</span>;</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">// child process code second</span></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (process_inter == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"this is child process i = %d"</span>, i);</span><br><span class="line">            usleep(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123; <span class="comment">// parent process code first</span></span><br><span class="line">    	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"this iparent process i = %d"</span>, i);</span><br><span class="line">            usleep(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        process_inter = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>无法通过<strong>用户空间</strong>全局变量实现进程间通信，上段程序只能运行父进程。</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/全局变量_进程通信_error.png" style="zoom:80%"><h4 id="2-进程通信方式"><a class="header-anchor" href="#2-进程通信方式">¶</a>2. 进程通信方式</h4><p><strong>单机模式</strong>下：（只有一个 Linux 内核）</p><ul><li>管道通信：无名管道、有名管道（文件系统中有名）</li><li>信号通信：信号的发送、信号的接收和信号的处理</li><li>IPC（Inter-Process Communication）：共享内存、消息队列和信号灯（量）</li></ul><p>多机模式下：（两个 Linux 内核）</p><ul><li>Socket 通信：存在于一个网络中两个进程之间的通信。</li></ul><h4 id="3-进程通信的学习思路"><a class="header-anchor" href="#3-进程通信的学习思路">¶</a>3. 进程通信的学习思路</h4><p>进程通信的学习思路：每一种通信方式都是基于文件IO的思想</p><ul><li><strong><code>open</code></strong> ：创建或者打开进程通信对象。函数形式可能不同，可能有多个函数完成</li><li><strong><code>write</code></strong> ：向进程通信对象中写入内容。函数形式可能不同。</li><li><strong><code>read</code></strong> ：从进程通信对象中读取内容。函数形式可能不同。</li><li><strong><code>close</code></strong> ：关闭或删除进程通信对象。函数形式可能不同。</li></ul><h3 id="二、无名管道"><a class="header-anchor" href="#二、无名管道">¶</a>二、无名管道</h3><p>通信原理：</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/无名管道通信原理.png" style="zoom:50%"><p>管道文件是一个特殊文件，是有<strong>队列</strong>来实现的。</p><h4 id="2-1-无名管道的创建"><a class="header-anchor" href="#2-1-无名管道的创建">¶</a>2.1 无名管道的创建</h4><p>在文件IO中创建一个文件或打开一个文件是由 <strong><code>open</code></strong> 函数实现的，它不能创建管道文件。只能用 <strong><code>pipe</code></strong> 函数来创建管道。</p><p><strong>函数形式</strong>： <strong><code>int pipe(int fd[2])</code></strong></p><p><strong>功能</strong>：创建管道，为系统调用， <strong><code>unistd.h</code></strong></p><p><strong>参数</strong>：就是得到的文件描述符。可见有两个文件描述符，<strong><code>fd[0]</code></strong>、<strong><code>fd[1]</code></strong>，管道有一个读端 <strong><code>fd[0]</code></strong> 用来读， <strong><code>fd[1]</code></strong> 用来写。</p><p><strong>返回值</strong>：成功 0，失败 -1</p><h4 id="2-2-pipe-函数使用"><a class="header-anchor" href="#2-2-pipe-函数使用">¶</a>2.2 <code>pipe</code> 函数使用</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">char</span> writebuf[] = <span class="string">"hello linux!"</span>;</span><br><span class="line">    <span class="keyword">char</span> readbuf[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ret = pipe(fd);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create pipe failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create pipe sucess fd[0] = %d, fd[1] = %d\n"</span>, fd[<span class="number">0</span>], fd[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">write</span>(fd[<span class="number">1</span>], writebuf, <span class="keyword">sizeof</span>(writebuf));</span><br><span class="line">    <span class="built_in">read</span>(fd[<span class="number">0</span>], readbuf, <span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"readbuf = %s\n"</span>, readbuf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意：</strong></p><ul><li>管道是创建在内存中的，<strong>进程结束，空间释放，管道就不再了</strong>；</li><li>管道中的东西，<strong>读完了就删除了</strong>；</li><li>如果管道没有东西可读，就会<strong>阻塞</strong>。</li></ul><h4 id="2-3-验证读阻塞"><a class="header-anchor" href="#2-3-验证读阻塞">¶</a>2.3 验证读阻塞</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">char</span> writebuf[] = <span class="string">"hello linux!"</span>;</span><br><span class="line">    <span class="keyword">char</span> readbuf[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ret = pipe(fd);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create pipe failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create pipe sucess fd[0] = %d, fd[1] = %d\n"</span>, fd[<span class="number">0</span>], fd[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">write</span>(fd[<span class="number">1</span>], writebuf, <span class="keyword">sizeof</span>(writebuf));</span><br><span class="line">    <span class="built_in">read</span>(fd[<span class="number">0</span>], readbuf, <span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"readbuf = %s\n"</span>, readbuf);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// second read from pipe</span></span><br><span class="line">    <span class="comment">// 会阻塞</span></span><br><span class="line">    <span class="built_in">memset</span>(readbuf, <span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">    <span class="built_in">read</span>(fd[<span class="number">0</span>], readbuf, <span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"readbuf = %s\n"</span>, readbuf);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E8%AF%BB%E9%98%BB%E5%A1%9E.png" alt></p><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E9%98%BB%E5%A1%9E_%E7%9D%A1%E7%9C%A0%E7%8A%B6%E6%80%81.png" alt="image-20210422190256281"></p><h4 id="2-4-验证写阻塞"><a class="header-anchor" href="#2-4-验证写阻塞">¶</a>2.4 验证写阻塞</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">char</span> writebuf[] = <span class="string">"hello linux!"</span>;</span><br><span class="line">    <span class="keyword">char</span> readbuf[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ret = pipe(fd);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create pipe failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create pipe sucess fd[0] = %d, fd[1] = %d\n"</span>, fd[<span class="number">0</span>], fd[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 可以通过 i 的设定，计算管道的大小</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; <span class="number">5500</span>) &#123;</span><br><span class="line">        <span class="built_in">write</span>(fd[<span class="number">1</span>], writebuf, <span class="keyword">sizeof</span>(writebuf));</span><br><span class="line">        i++;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"write pipe end\n"</span>); </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E5%86%99%E9%98%BB%E5%A1%9E.png" alt></p><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/%E5%86%99%E9%98%BB%E5%A1%9E_%E7%9D%A1%E7%9C%A0%E7%8A%B6%E6%80%81.png" alt></p><h4 id="2-5-实现进程通信。"><a class="header-anchor" href="#2-5-实现进程通信。">¶</a>2.5 实现进程通信。</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">char</span> process_inter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建管道</span></span><br><span class="line">    ret = pipe(fd);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create pipe failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create pipe success\n"</span>);</span><br><span class="line">    </span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">// child process code second</span></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// if pipe empty  sleep</span></span><br><span class="line">        <span class="comment">//需要注意该process与父进程process同名而已</span></span><br><span class="line">        <span class="keyword">while</span> (process_inter == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"this is child process i = %d"</span>, i);</span><br><span class="line">            usleep(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123; <span class="comment">// parent process code first</span></span><br><span class="line">    	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"this iparent process i = %d"</span>, i);</span><br><span class="line">            usleep(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        process_inter = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">write</span>(fd[<span class="number">1</span>], &amp;process_inter, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以实现进程间通信</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/管道_进程通信.png" style="zoom:80%"><h3 id="三、有名管道"><a class="header-anchor" href="#三、有名管道">¶</a>三、有名管道</h3><p>无名管道的**<font color="FF000">缺点</font>**：<strong>不能实现不是父子进程（亲缘关系）之间的通信。</strong></p><p>正由于这无名管道的缺点，对于无名管道进行改进，<strong>有名管道。</strong></p><p>所谓的<strong>有名</strong>，即文件系统中存在这个一样文件节点，每一个文件节点都有一个 <strong><code>inode</code></strong> 号，而且这是一个特殊的文件类型： <strong><code>p</code></strong> 管道类型。</p><ol><li><p><strong><font color="FF000">创建</font><strong>这个文件节点，不可以通过 <strong><code>open</code></strong> 函数，</strong><code>open</code></strong> 函数只能创建普通文件，不能创建特殊文件（管道- <strong><code>mkfifo</code></strong> ，套接字- <strong><code>socket</code></strong> ，字符设备文件- <strong><code>mknod</code></strong> ，块设备文件- <strong><code>mknod</code></strong> ，符号链接文件-<strong><code>ln -s</code></strong>，目录文件- <strong><code>mkdir</code></strong> ）</p></li><li><p>管道文件只有 <strong><code>inode</code></strong> 号，不占磁盘块空间，和套接字、字符设备文件、块设备文件一样。普通文件和符号链接文件及目录文件，不仅有 <strong><code>inode</code></strong> 号，还占有磁盘块空间</p></li><li><p><strong><code>mkfifo</code></strong> : 用来<strong>创建</strong>管道文件的<strong>节点</strong>，<strong>没有在内核中创建管道</strong>。只有通过 <strong><code>open</code></strong> 函数<strong>打开这个文件时才会在内核空间创建管道</strong>。</p></li></ol><h4 id="3-1-有名管道的创建"><a class="header-anchor" href="#3-1-有名管道的创建">¶</a>3.1 有名管道的创建</h4><p><strong><code>mkfifo</code> 的用法</strong></p><p><strong>函数形式: <code>int mkfifo(const char* filename, mode_t mode);</code></strong> 创建管道文件。</p><p><strong>参数</strong>：管道文件名，权限，创建的文件权限任然和 <strong><code>umask</code></strong> 有关系</p><p><strong>返回值</strong>：创建成功返回 0，失败返回 -1。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    ret = mkfifo(<span class="string">"./myfifo"</span>, <span class="number">0777</span>); <span class="comment">// 权限 0777</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create myfifo failure \n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create myfifo success \n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-通过管道实现无亲缘关系进程间通信"><a class="header-anchor" href="#3-2-通过管道实现无亲缘关系进程间通信">¶</a>3.2 通过管道实现无亲缘关系进程间通信</h4><p><strong><code>first.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"fcntl.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">char</span> process_inter = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 打开之前创建的管道类型文件</span></span><br><span class="line">    fd = <span class="built_in">open</span>(<span class="string">"./myfifo"</span>, O_WRONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"open myfifo failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"open myfifo success \n"</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"this is first process i = %d\n"</span>, i);</span><br><span class="line">        usleep(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    process_inter = <span class="number">1</span>;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// 向管道中写</span></span><br><span class="line">    <span class="built_in">write</span>(fd, &amp;process_inter, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>second.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"fcntl.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">char</span> process_inter = <span class="number">0</span>;</span><br><span class="line">    fd = <span class="built_in">open</span>(<span class="string">"./myfifo"</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"open myfifo failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"open myfifo success \n"</span>);</span><br><span class="line">    <span class="comment">// 从管道中读</span></span><br><span class="line">    <span class="built_in">read</span>(fd, &amp;process_inter, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span> (process_inter == <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"this is second process i = %d\n"</span>, i);</span><br><span class="line">        usleep(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先运行 <strong><code>first</code></strong> <strong>open</strong> 管道文件：<strong><code>myfifo</code></strong></p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/开启first.png" style="zoom:80%"><p>运行 <strong><code>second</code></strong> ，此时两端开始通信，<strong><code>first</code></strong> 先运行，<strong><code>second</code></strong> 后运行</p><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/first_after_second.png" style="zoom:80%"> <img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/second.png" style="zoom:80%"></p><h3 id="四、信号通信"><a class="header-anchor" href="#四、信号通信">¶</a>四、信号通信</h3><p>信号通信，其实就是内核向用户空间进程**<font color="FF0000">发送信号</font><strong>，只有</strong><font color="FF0000">内核才能发信号</font>**，用户空间进程不能发信号。</p><p>内核可以发送<strong>多少种</strong>信号？<strong><code>kill -l</code></strong> : <strong>64 种</strong>，常见命令：<strong><code>kill 9 pid</code></strong> (杀死进程)</p><p>信号通信的框架</p><ul><li>信号的发送（发送信号进程）： <strong><code>kill</code> <font color="FF0000"><code>raise</code></font> <code>alarm</code></strong></li><li>信号的接收（接收信号进程）： <strong><code>pause()</code> <code>sleep</code> <code>while(1)</code></strong></li><li>信号的处理（接收信号进程）： <strong><code>signal</code></strong></li></ul><h4 id="4-1-信号的发送（发送信号进程）"><a class="header-anchor" href="#4-1-信号的发送（发送信号进程）">¶</a>4.1 信号的发送（发送信号进程）</h4><h5 id="4-1-1-kill"><a class="header-anchor" href="#4-1-1-kill">¶</a>4.1.1 <strong><code>kill</code></strong></h5><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/kill操作.png" style="zoom:50%"><p><strong>例子：编写自己的kill函数</strong></p><p>创建一个简单的进程 <strong><code>test.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 死循环</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后系统死循环<br><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/image-20210423171228323.png" alt="image-20210423171228323"></p><p><strong><code>mykill.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sig;</span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"please input param\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sig = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    pid = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"sig = %d, pid = %d \n"</span>, sig, pid);</span><br><span class="line">    <span class="comment">// 调用系统函数</span></span><br><span class="line">    kill(pid, sig);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 <strong>9</strong> 号信号量 <strong><code>SIGKILL</code></strong> 来 <strong>kill</strong> 掉 <strong><code>./test</code></strong> 进程</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/image-20210423171719834.png" alt="image-20210423171719834" style="zoom:80%"> <img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/image-20210423171538416.png" alt="image-20210423171538416" style="zoom:80%"><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/image-20210423171817097.png" alt="image-20210423171817097"></p><h5 id="4-1-2-raise"><a class="header-anchor" href="#4-1-2-raise">¶</a>4.1.2 raise</h5><p><strong><code>raise</code></strong> : 发信号给自己，等价于 <strong><code>kill(getpid(), sig)</code></strong></p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise函数.png" style="zoom:67%"><p><strong>例子：raise 函数</strong></p><p><strong><code>raise.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"raise before"</span>);   <span class="comment">// 输出结果见1图，它只是将该语句写入库函数缓存，没有写入内核</span></span><br><span class="line">    <span class="comment">// printf("raise before\n");  // 输出结果见2图</span></span><br><span class="line">    raise(<span class="number">9</span>); <span class="comment">// 相当于_exit()，而非exit();</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"raise after\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_01.png" alt="raise_01"></p><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_02.png" alt></p><p><strong><code>raise_2.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        sleep(<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">"raise function before\n"</span>);</span><br><span class="line">        raise(SIGTSTP); <span class="comment">// 进程进入暂停状态（T）</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"raise function after\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>程序运行后，首先子进程输出语句</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_05.png" style="zoom:80%"><p>之后调用 <strong><code>raise</code></strong> 函数进入暂停状态，此时父进程睡眠状态 <strong><code>S</code></strong>，子进程暂停状态 <strong><code>T</code></strong></p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_03.png" style="zoom:80%"><p>父进程睡眠 8 秒后，父进程进入运行状态 <strong><code>R</code></strong> ，此时子进程仍然是暂停状态 <strong><code>T</code></strong></p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_04.png" style="zoom:80%"><p>稍微修改一下 <strong><code>raise_2.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        sleep(<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (waitpid(pid, <span class="literal">NULL</span>, WNOHANG) == <span class="number">0</span>) &#123;</span><br><span class="line">            kill(pid, <span class="number">9</span>); <span class="comment">// 杀死子进程，此时父进程没有对其进行回收资源(wait)</span></span><br><span class="line">            			  <span class="comment">// 子进程会变成僵尸进程</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// wait(NULL); // 加上 wait 函数回收子进程资源，子进程就不会变成僵尸进程</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">"raise function before\n"</span>);</span><br><span class="line">        raise(SIGTSTP); <span class="comment">// 进程进入暂停状态（T）</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"raise function after\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>程序运行后，首先子进程输出语句</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_05.png" style="zoom:67%"><p>之后调用 <strong><code>raise</code></strong> 函数进入暂停状态，此时父进程睡眠状态 <strong><code>S</code></strong>，子进程暂停状态 <strong><code>T</code></strong></p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_06.png" style="zoom:80%"><p>父进程睡眠 8 秒后，父进程进入运行状态 <strong><code>R</code></strong> ，此时子进程进入僵尸状态 <strong><code>Z</code></strong></p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_07.png" style="zoom:80%"><p>加上 <strong><code>wait()</code></strong> 子进程被 <strong><code>kill</code></strong> 后不会变成僵尸进程</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/raise_08.png" style="zoom:80%"><h5 id="4-1-3-alarm"><a class="header-anchor" href="#4-1-3-alarm">¶</a>4.1.3 <code>alarm</code></h5><p><strong><code>alarm</code></strong> 与 <strong><code>raise</code></strong> 的比较：</p><ul><li><p><strong>相同点</strong>：让内核发送信号给当前进程</p></li><li><p><strong>不同点</strong>：</p><ul><li><p><strong><code>alarm</code></strong> 只会发送 <strong><code>SIGALARM</code></strong> 信号 (<strong>14</strong> 号信号)</p></li><li><p><strong><code>alarm</code></strong> 会让内核<strong>定时</strong>一段时间之后发送信号， <strong><code>raise</code></strong> 会让内核<strong>立刻</strong>发信号</p></li></ul></li></ul><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/alarm函数.png" style="zoom:67%"><p><strong>例子：alarm</strong></p><p><strong><code>alarm.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"alarm before\n"</span>);   </span><br><span class="line">    alarm(<span class="number">9</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"alarm before\n"</span>);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; <span class="number">20</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"process things, i = %d \n"</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果如下所示，<strong><code>alarm</code></strong> 在 9 秒后终止操作</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/alarm_01.png" style="zoom:80%"><h4 id="4-2-信号的接收（接收信号进程）"><a class="header-anchor" href="#4-2-信号的接收（接收信号进程）">¶</a>4.2 信号的接收（接收信号进程）</h4><p>接收信号的进程的条件：要想使接收的进程能接收信号，这个进程不能结束</p><ul><li><p><strong><code>sleep</code></strong></p></li><li><p><strong><code>while(1)</code></strong></p></li><li><p><strong><code>pause</code></strong> 进程状态为 <strong><code>S</code></strong></p></li></ul><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/pause函数.png" style="zoom:67%"><p><strong><code>pause.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"pause before \n"</span>);</span><br><span class="line">    pause();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"pause after \n"</span>);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; <span class="number">20</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"process things, i = %d"</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行程序后，进程处于睡眠状态 <strong><code>S</code></strong></p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/pause_01.png" style="zoom:80%"> <img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/pause_02.png" style="zoom:80%"><h4 id="4-3-信号的处理（接收信号进程）"><a class="header-anchor" href="#4-3-信号的处理（接收信号进程）">¶</a>4.3 信号的处理（接收信号进程）</h4><p>收到信号的进程，应该怎样处理？处理的方式：</p><p>（1）进程的<strong>默认</strong>处理方式（内核为用户进程设置的默认处理方式）：</p><ul><li>忽略</li><li>终止进程</li><li>暂停</li></ul><p>（2）自定义的处理方式：自定义处理信号的方法告诉内核，这样线程收到了这个信号就会采用自定义的处理方式</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal函数.png" style="zoom:67%"><p><strong><code>signal</code></strong> 函数有两个参数，</p><ul><li><p>第一个参数是一个整形变量（信号值），</p></li><li><p>第二个参数是一个函数指针，是自定义的处理函数，这个函数的返回值是一个函数指针。</p></li></ul><h5 id="4-3-1-自定义处理"><a class="header-anchor" href="#4-3-1-自定义处理">¶</a>4.3.1 自定义处理</h5><p><strong><code>signal.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfun</span><span class="params">(<span class="keyword">int</span> signum)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"process signal signum = %d, i = %d\n"</span>, signum);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>; <span class="comment">// return main</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    signal(<span class="number">14</span>, myfun);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"alarm before \n"</span>);</span><br><span class="line">    alarm(<span class="number">9</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"alarm after \n"</span>);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; <span class="number">20</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"process things, i = %d\n"</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>signal(14, myfun);</code></strong> 表示接收到 14 号信号，进行自定义的一些处理（<strong>14号信号 --&gt; alarm</strong>）</p><p>程序运行，9秒后发送 <strong><code>alarm</code></strong> 信号，期间进程一直运行</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_01.png" style="zoom:80%"><p>接收到 <strong><code>alarm</code></strong> 信号后，处理 <strong><code>myfun</code></strong></p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_02.png" style="zoom:80%"><p>处理 <strong><code>myfun</code></strong> 结束后，重新回到 <strong><code>main</code></strong> 中继续进行剩下的操作</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_03.png" style="zoom:80%"><h5 id="4-3-2-SIG-IGN-SIG-DFL"><a class="header-anchor" href="#4-3-2-SIG-IGN-SIG-DFL">¶</a>4.3.2 <code>SIG_IGN</code> , <code>SIG_DFL</code></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfun</span><span class="params">(<span class="keyword">int</span> signum)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"process signal signum = %d"</span>, signum);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>; <span class="comment">// return main</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    signal(<span class="number">14</span>, myfun);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"alarm before \n"</span>);</span><br><span class="line">    alarm(<span class="number">9</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"alarm after \n"</span>);</span><br><span class="line">    signal(<span class="number">14</span>, SIG_IGN);  <span class="comment">// 又一次接收到信号，忽略它，不会处理myfun，也不会终止运行</span></span><br><span class="line">    <span class="comment">// signal(14, SIG_DFL);  // 默认处理，9秒后终止</span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; <span class="number">20</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"process things, i = %d"</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>SIG_IGN</code></strong> , <strong><code>SIG_DFL</code></strong><br><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_04.png" style="zoom:67%"><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_05.png" style="zoom:80%"></p><h4 id="4-4-signal-处理进程间通信"><a class="header-anchor" href="#4-4-signal-处理进程间通信">¶</a>4.4 signal 处理进程间通信</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfun</span><span class="params">(<span class="keyword">int</span> signum)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"receive signum = %d, i = %d\n"</span>, signum, i);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        signal(<span class="number">10</span>, myfun);</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"parent process things, i = %d\n"</span>, i);</span><br><span class="line">            sleep(i);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    	sleep(<span class="number">10</span>);</span><br><span class="line">        kill(getppid(), <span class="number">10</span>);    <span class="comment">// SIGUSER1  10 信号</span></span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>父进程死循环打印输出，子进程睡眠 10 s 后发送 10 号 <strong><code>SIGUSER1</code></strong> 信号，父进程接收到信号就会跳入处理自定义函数 <strong><code>myfun</code></strong> ，处理结束后基于死循环打印输出。结果如下：</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_06.png" style="zoom:67%"><p>此时进程状态如下，父进程运行状态( <strong><code>R</code></strong> )，子进程僵尸状态 ( <strong><code>Z</code></strong> ) ，需要父进程进行资源回收处理。</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_07.png" style="zoom:80%"><p>因为 <strong><code>wait()</code></strong> 操作为阻塞操作，不能直接放在处理函数之上，这会导致处理函数不会进行下去。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        signal(<span class="number">10</span>, myfun);</span><br><span class="line">    	wait(<span class="literal">NULL</span>); <span class="comment">// 放在这里会阻塞后续处理。</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"parent process things, i = %d\n"</span>, i);</span><br><span class="line">            sleep(i);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>由结果可以知道，父进程开始会处于 <strong><font color="FF000">阻塞状态</font></strong> ，只有接收 10 号信号后才会处理 <strong><code>myfun</code></strong> ，之后**<font color="FF000">等子进程退出</font>**，之后才会处理 <strong><code>printf</code></strong> 操作</p><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_08.png" alt></p><p>因为 <strong><code>exit(0)</code></strong> 发送了 <strong><code>kill SIGCHLD</code></strong> 信号，<strong>17 号信号</strong>，所以父进程可以接收 17 信号后处理 <strong><code>wait</code></strong> 即可</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfun1</span><span class="params">(<span class="keyword">int</span> signum)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"receive signum = %d\n"</span>,signum);</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        signal(<span class="number">10</span>, mufun);</span><br><span class="line">    	signal(<span class="number">17</span>, myfun1);</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"parent process things, i = %d\n"</span>, i);</span><br><span class="line">            sleep(i);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这样的话，在子进程结束之后，就不会产生僵尸进程</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_09.png" style="zoom:80%"> <img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/signal_10.png" style="zoom:80%"><h3 id="五、IPC-通信"><a class="header-anchor" href="#五、IPC-通信">¶</a>五、IPC 通信</h3><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/IPC对象.png" style="zoom:50%"> <img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/IPC与IO对比.png" style="zoom:67%"><p>常用的 IPC 相关的 <strong><code>shell</code></strong> 命令</p><p>查看 IPC 对象 ： <strong><code>ipcs</code> <code>-m</code></strong> (共享内存) <strong><code>-q</code></strong> (消息队列) <strong><code>-s</code></strong> (信号灯)</p><p>删除 IPC 对象：<strong><code>ipcrm</code> <code>-m</code></strong> (共享内存) \ <strong><code>-q</code></strong> (消息队列) \ <strong><code>-s</code></strong> (信号灯) <strong><code>id</code></strong></p><p>返回值：<strong>共享内存</strong>，<strong>消息队列</strong>，<strong>信号灯</strong>标识符，IPC 的 ID 号</p><p>每次用 <strong><code>IPC_PRIVATE</code></strong> 操作时， <strong><code>key</code></strong> 都是一样的，都是 0</p><h3 id="六、共享内存"><a class="header-anchor" href="#六、共享内存">¶</a>六、共享内存</h3><h4 id="6-1-创建和打开共享内存"><a class="header-anchor" href="#6-1-创建和打开共享内存">¶</a>6.1 创建和打开共享内存</h4><p><strong><code>shmget</code></strong> 函数</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmget函数.png" style="zoom:67%"> 出错：返回 - 1<p><strong><code>shmget.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/shm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    shmid = shmget(IPC_PRIVATE, <span class="number">128</span>, <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create share memory failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"creat share memory success shmid = %d\n"</span>, shmid);</span><br><span class="line">    system(<span class="string">"ipcs -m"</span>);</span><br><span class="line">    <span class="comment">// system("ipcrm -m shmid");</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每次运行一次，创建一个共享内存，下图运行三次后。</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmget_01.png" style="zoom:80%"><p>使用 <strong><code>ipcrm -m id</code></strong> 删除后两个共享内存</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmget_02.png" style="zoom:80%"><h4 id="6-2-ftok-函数，创建-key-值"><a class="header-anchor" href="#6-2-ftok-函数，创建-key-值">¶</a>6.2 ftok 函数，创建 key 值</h4><p><strong><code>char ftok(const char* path, char key)</code></strong></p><ul><li><p><strong>参数</strong>：第一个参数：文件路径和文件名；第二个参数：一个字符</p></li><li><p><strong>返回值</strong>：正确返回一个 key 值，出错返回 -1</p></li></ul><p><strong><code>IPC_PRIVATE</code></strong> 操作时，共享内存的 key 值都是一样，都是 <strong>0</strong>， 所以对于非亲缘关系进程使用 <strong><code>ftok</code></strong> 来创建 key 值。只要 key 值是一样的，用户空间的进程通过这个函数打开，则会对内核的同一个 IPC 对象操作。</p><p><strong><code>shmget.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/shm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    key = ftok(<span class="string">"./a.c"</span>, <span class="string">'a'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create key success, key = %X\n"</span>, key);</span><br><span class="line">    shmid = shmget(key, <span class="number">128</span>, IPC_CREAT | <span class="number">0777</span>);  <span class="comment">// 需要在权限处加上宏 TPC_CREAT</span></span><br><span class="line">    <span class="comment">// shmid = shmget(IPC_PRIVATE, 128, 0777); 对比</span></span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create share memory failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"creat share memory success shmid = %d\n"</span>, shmid);</span><br><span class="line">    system(<span class="string">"ipcs -m"</span>);</span><br><span class="line">    <span class="comment">// system("ipcrm -m shmid");</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果如下：之前用 <strong><code>IPC_PRIVATE</code></strong> 创建的 key = 0，现在用自定义的 key</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmget_03.png" style="zoom:80%"><h4 id="6-3-将共享内存映射到用户空间中"><a class="header-anchor" href="#6-3-将共享内存映射到用户空间中">¶</a>6.3 将共享内存映射到用户空间中</h4><p>为了方便用户空间对共享内存的操作，使用地址映射的方式。利用 <strong><code>shmat</code></strong> 函数。</p><p><strong><code>void *shmat (int shmid, const void * shmaddr, int shmflg);</code></strong></p><p><strong>参数</strong>：</p><ul><li><p>第一个参数：ID号；</p></li><li><p>第二个参数：映射到的地址，<strong>NULL</strong> 为系统自动完成的映射；</p></li><li><p>第三个参数：<code>shmflg</code></p><ul><li>**<code>SHM_RDONLY</code>**共享内存只读</li><li>默认 0，表示共享内存可读写</li></ul></li></ul><p>返回值： 成功：映射后的地址；失败：<strong>NULL</strong></p><p><strong><code>shmat.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/shm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    key = ftok(<span class="string">"./a.c"</span>, <span class="string">'a'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create key success, key = %X\n"</span>, key);</span><br><span class="line">    shmid = shmget(key, <span class="number">128</span>, IPC_CREAT | <span class="number">0777</span>); </span><br><span class="line">    <span class="comment">// shmid = shmget(IPC_PRIVATE, 128, 0777); 对比</span></span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create share memory failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"creat share memory success shmid = %d\n"</span>, shmid);</span><br><span class="line">    system(<span class="string">"ipcs -m"</span>);</span><br><span class="line">    </span><br><span class="line">    p = (<span class="keyword">char</span> *)shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"shmat function failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// write share memory</span></span><br><span class="line">    <span class="comment">// stdin:键盘输入，128字节，写入 p 中</span></span><br><span class="line">    fgets(p, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// start read share memory</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"share memory data: %s\n"</span>, p);</span><br><span class="line">    <span class="comment">// printf("share memory data: %s\n", p);</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>程序运行后，键盘输入: test 进共享内存，后读数据输出</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmat01.png" style="zoom:80%"><p><strong>与管道不同</strong>，共享内存中的数据在读取后<strong>并没有被删除</strong>，两条输出语句的结果如下：</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmat02.png" style="zoom:80%"><p><strong>共享内存特点：</strong></p><ul><li>共享内存创建后，一直存在于内核中，知道被删除或系统关闭；</li><li>共享内存和管道不一样，读取后，内容仍在其共享内存中。</li></ul><h4 id="6-4-删除进程里的地址映射"><a class="header-anchor" href="#6-4-删除进程里的地址映射">¶</a>6.4 删除进程里的地址映射</h4><p>使用 <strong><code>shmdt</code></strong> 函数，删除用户空间的地址映射</p><p><strong><code>int shmdt(const void* shmaddr);</code></strong></p><p><strong>参数</strong>：<strong><code>shmaddr</code></strong> ：共享内存映射后的地址（用户空间）</p><p><strong>返回值</strong>：成功：0； 失败： -1</p><p><strong><code>shmdt.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/shm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    key = ftok(<span class="string">"./a.c"</span>, <span class="string">'a'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create key success, key = %X\n"</span>, key);</span><br><span class="line">    shmid = shmget(key, <span class="number">128</span>, IPC_CREAT | <span class="number">0777</span>); </span><br><span class="line">    <span class="comment">// shmid = shmget(IPC_PRIVATE, 128, 0777); 对比</span></span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create share memory failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"creat share memory success shmid = %d\n"</span>, shmid);</span><br><span class="line">    system(<span class="string">"ipcs -m"</span>);</span><br><span class="line">    </span><br><span class="line">    p = (<span class="keyword">char</span> *)shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"shmat function failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// write share memory</span></span><br><span class="line">    <span class="comment">// stdin:键盘输入，128字节，写入 p 中</span></span><br><span class="line">    fgets(p, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// start read share memory</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"share memory data: %s\n"</span>, p);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"share memory data: %s\n"</span>, p);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放用户空间共享内存</span></span><br><span class="line">    shmdt(p);</span><br><span class="line">    <span class="built_in">memcpy</span>(p, <span class="string">"abcd"</span>, <span class="number">4</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>共享内存释放后，不能再次使用它，所以 <strong><code>memcpy</code></strong> 函数操作会出现段错误。</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmdt_01.png" style="zoom:80%"><h4 id="6-5-shmctl：删除共享内存对象"><a class="header-anchor" href="#6-5-shmctl：删除共享内存对象">¶</a>6.5 shmctl：删除共享内存对象</h4><p><strong><code>int shmctl(int shmid, int cmd, struct shmid_ds *buf)</code></strong></p><p><strong>参数</strong>：</p><ul><li><p><strong><code>shmid</code></strong> ：要操作的共享内存标识符</p></li><li><p><strong><code>cmd</code></strong> ：</p><ul><li><strong><code>IPC_STAT</code></strong> (获取对象属性) – 实现了 <strong><code>ipcs - m</code></strong></li><li><strong><code>IPC_SET</code></strong> （设置对象属性）</li><li><strong><code>IPC_RMID</code></strong> (删除对象) – 实现了 <strong><code>ipcrm -m id</code></strong></li></ul></li><li><p><strong><code>buf</code></strong> : 指定 <strong><code>IPC_STAT/IPC_SET</code></strong> 时可以保存 / 设置属性。</p></li></ul><p><strong>返回值</strong>：成功：0； 失败：-1；</p><p><strong><code>shmctl.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/shm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    key = ftok(<span class="string">"./a.c"</span>, <span class="string">'a'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create key success, key = %X\n"</span>, key);</span><br><span class="line">    shmid = shmget(key, <span class="number">128</span>, IPC_CREAT | <span class="number">0777</span>); </span><br><span class="line">    <span class="comment">// shmid = shmget(IPC_PRIVATE, 128, 0777); 对比</span></span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create share memory failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"creat share memory success shmid = %d\n"</span>, shmid);</span><br><span class="line">    system(<span class="string">"ipcs -m"</span>);</span><br><span class="line">    </span><br><span class="line">    p = (<span class="keyword">char</span> *)shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"shmat function failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// write share memory</span></span><br><span class="line">    <span class="comment">// stdin:键盘输入，128字节，写入 p 中</span></span><br><span class="line">    fgets(p, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// start read share memory</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"share memory data: %s\n"</span>, p);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"share memory data: %s\n"</span>, p);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放用户空间共享内存</span></span><br><span class="line">    shmdt(p);</span><br><span class="line">    <span class="built_in">memcpy</span>(p, <span class="string">"abcd"</span>, <span class="number">4</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 删除共享内存对象</span></span><br><span class="line">    shmctl(shmid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">"ipcs -m"</span>);<span class="comment">// 查看共享内存还在不在</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行程序，键盘输入 test ，结果打印两遍后删除共享内存对象，发现 <strong><code>shmid = 3</code></strong> 的共享内存被删除。</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmctl_01.png" style="zoom:80%"><p><strong><code>myipcrm.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/shm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"please input param\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-m"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"delete share memory\n"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    shmid = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"shmid = %d\n"</span>, shmid);</span><br><span class="line">    shmctl(shmid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">    system(<span class="string">"ipcs -m"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>自己创建的 <strong><code>ipcrm -m id</code></strong> 操作，成功的删除了 <strong><code>shmid = 0</code></strong> 的共享内存</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmctl_02.png" style="zoom:80%"><h4 id="6-6-有亲缘关系的进程（IPC-PRIVATE）"><a class="header-anchor" href="#6-6-有亲缘关系的进程（IPC-PRIVATE）">¶</a>6.6 有亲缘关系的进程（IPC_PRIVATE）</h4><p><strong><code>shmctl_2.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/shm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 信号处理函数，不需要任何处理，主要为了唤醒 pause 函数，且避免 sigusr1/2终止函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfun</span><span class="params">(<span class="keyword">int</span> signum)</span> </span>&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="keyword">char</span>* p;</span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    shmid = shmget(IPC_PRIVATE, <span class="number">128</span>, IPC_CREAT | <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"creat share memory failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"creat memory success shmid = %d\n"</span>, shmid);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// shmget 在 fork 之前</span></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        signal(SIGUSR2, myfun);</span><br><span class="line">        p = (<span class="keyword">char</span> *)shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"shmat function failure\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// write share memory</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"parent process start write share memory: \n"</span>);</span><br><span class="line">            fgets(p, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">            kill(pid, SIGUSR1); <span class="comment">// 通知子进程去读</span></span><br><span class="line">            pause(); <span class="comment">// 等待子进程去读</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        signal(SIGUSR1, myfun);</span><br><span class="line">        p = (<span class="keyword">char</span> *) shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"shmat function failure\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">            pause(); <span class="comment">// 等待父进程去写</span></span><br><span class="line">        	<span class="built_in">printf</span>(<span class="string">"share memory data: %s\n"</span>, p);</span><br><span class="line">            kill(getppid(), SIGUSR2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>程序运行，父进程写，子进程读取，两个进程状态都是睡眠状态 （<strong><code>S</code></strong>）</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmctl_03.png" style="zoom:80%"> <img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shmctl_04.png" style="zoom:80%"><h4 id="6-7-无亲缘关系的进程（key）"><a class="header-anchor" href="#6-7-无亲缘关系的进程（key）">¶</a>6.7 无亲缘关系的进程（key）</h4><p><strong><code>server.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/shm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mybuf</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">124</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 信号处理函数，不需要任何处理，主要为了唤醒 pause 函数，且避免 sigusr1/2终止函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfun</span><span class="params">(<span class="keyword">int</span> signum)</span> </span>&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mybuf</span>* <span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="comment">// 创建 key</span></span><br><span class="line">    key = ftok(<span class="string">"./a.c"</span>,<span class="string">'c'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create key success, key = %X\n"</span>, key);</span><br><span class="line">    <span class="comment">// 创建 share memory</span></span><br><span class="line">    shmid = shmget(key, <span class="number">128</span>, IPC_CREAT | <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"creat share memory failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"creat memory success shmid = %d\n"</span>, shmid);</span><br><span class="line">	<span class="comment">// 信号处理</span></span><br><span class="line">    signal(SIGUSR2, myfun);</span><br><span class="line">    <span class="comment">// 地址映射</span></span><br><span class="line">    p = (struct mybuf*)shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"shmat function failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// get client pid</span></span><br><span class="line">    p-&gt;pid = getpid(); <span class="comment">// write server pid to share memory</span></span><br><span class="line">    pause(); <span class="comment">//wait client read server pid;</span></span><br><span class="line">    pid = p-&gt;pid;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// write share memory</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">" process start write share memory: \n"</span>);</span><br><span class="line">        fgets(p-&gt;buf, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">        kill(pid, SIGUSR1); <span class="comment">// 通知client进程去读</span></span><br><span class="line">        pause(); <span class="comment">// 等待client 进程去读</span></span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>client.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/shm.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mybuf</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">124</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 信号处理函数，不需要任何处理，主要为了唤醒 pause 函数，且避免 sigusr1/2终止函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfun</span><span class="params">(<span class="keyword">int</span> signum)</span> </span>&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mybuf</span>* <span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="comment">// 创建 key</span></span><br><span class="line">    key = ftok(<span class="string">"./a.c"</span>,<span class="string">'c'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create key success, key = %X\n"</span>, key);</span><br><span class="line">    <span class="comment">// 创建 share memory</span></span><br><span class="line">    shmid = shmget(key, <span class="number">128</span>, IPC_CREAT | <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (shmid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"creat share memory failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"creat memory success shmid = %d\n"</span>, shmid);  </span><br><span class="line">    <span class="comment">// 信号处理</span></span><br><span class="line">    signal(SIGUSR1, myfun);</span><br><span class="line">    <span class="comment">// 地址映射</span></span><br><span class="line">    p = (struct mybuf*)shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"shmat function failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">// get server pid</span></span><br><span class="line">    <span class="comment">// read share memory</span></span><br><span class="line">    pid = p-&gt;pid;</span><br><span class="line">    <span class="comment">// write client pid to share memory</span></span><br><span class="line">    p-&gt;pid = getpid();</span><br><span class="line">    kill(pid, SIGUSR2);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// client start read data from share memory</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        pause(); <span class="comment">// wait server write data to share memory;</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"client process receive data from share memory: %s"</span>, p-&gt;buf);</span><br><span class="line">        kill(pid, SIGUSR2); <span class="comment">// server may write share memory</span></span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该程序的关键是：要先通过共享内存交互双方的 <strong><code>pid</code></strong>;</p><p>运行服务器，客户端程序，可以发现双方都可以操作 <strong><code>shmid = 8</code></strong> 的共享内存，服务器端发送多次发送数据，客户端多次接受数据；服务器每次发送完，等待下一次输入；客户端每次接受，等待下一次服务器的消息发送。</p><p>结果如下：</p><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shm_server.png" alt></p><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/shm_client.png" alt></p><h3 id="七、消息队列"><a class="header-anchor" href="#七、消息队列">¶</a>七、消息队列</h3><p>链式队列</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/消息队列数据结构.png" style="zoom:80%"><p><strong><code>msqid_ds</code></strong> 内核维护消息队列的结构体，队列的第一个消息指针 <strong><code>msg_first</code></strong>，最后一个消息指针 <strong><code>msg_last</code></strong> ，消息中有一个成员指针 <strong><code>next</code></strong></p><p>每一个消息中包含有哪些内容：</p><ul><li>Data ：数据</li><li>Length：数据的长度</li><li>Type：数据的类型</li></ul><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/消息函数.png" style="zoom:80%"><h4 id="7-1-消息队列的创建和打开"><a class="header-anchor" href="#7-1-消息队列的创建和打开">¶</a>7.1 消息队列的创建和打开</h4><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgget函数.png" style="zoom:80%"><p><strong><code>msgget.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/msg.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msgid;</span><br><span class="line">    msgid = msgget(IPC_PRIVATE,<span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (msgid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create message queue failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create message queue success, msgid = %d\n"</span>, msgid);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>三次运行程序创建了三个消息队列</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgget_01.png" style="zoom:80%"><h4 id="7-2-消息队列控制"><a class="header-anchor" href="#7-2-消息队列控制">¶</a>7.2 消息队列控制</h4><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgctl函数.png" style="zoom:67%"><p><strong><code>msgctl.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/msg.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msgid;</span><br><span class="line">    msgid = msgget(IPC_PRIVATE,<span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (msgid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create message queue failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create message queue success, msgid = %d\n"</span>, msgid);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// delete message queue</span></span><br><span class="line">    msgctl(msgid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>程序运行，先创建一个 <strong><code>msgid = 3</code></strong> 消息队列，之后删除它</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgctl_01.png" style="zoom:80%"><h4 id="7-3-消息发送"><a class="header-anchor" href="#7-3-消息发送">¶</a>7.3 消息发送</h4><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgsnd函数.png" style="zoom:67%"><p><strong><code>msgsnd.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/msg.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> type;</span><br><span class="line">    <span class="keyword">char</span> voltage[<span class="number">124</span>];</span><br><span class="line">    <span class="keyword">char</span> ID[<span class="number">4</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msgid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">sendbuf</span>;</span></span><br><span class="line">    msgid = msgget(IPC_PRIVATE,<span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (msgid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create message queue failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create message queue success, msgid = %d\n"</span>, msgid);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// init sendbuf</span></span><br><span class="line">    sendbuf.type = <span class="number">100</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"please input message:\n"</span>);</span><br><span class="line">    fgets(sendbuf.voltage, <span class="number">124</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// start write message to message queue</span></span><br><span class="line">    msgsnd(msgid, (<span class="keyword">void</span> *)&amp;sendbuf, <span class="built_in">strlen</span>(sendbuf.voltage), <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// delete message queue</span></span><br><span class="line">    msgctl(msgid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7-4-消息接收"><a class="header-anchor" href="#7-4-消息接收">¶</a>7.4 消息接收</h4><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgrcv函数.png" style="zoom:67%"><p><strong><code>msgrcv.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/msg.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> type;</span><br><span class="line">    <span class="keyword">char</span> voltage[<span class="number">124</span>];</span><br><span class="line">    <span class="keyword">char</span> ID[<span class="number">4</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msgid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">sendbuf</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">recvbuf</span>;</span></span><br><span class="line">    <span class="keyword">int</span> readret;</span><br><span class="line">    msgid = msgget(IPC_PRIVATE,<span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (msgid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create message queue failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create message queue success, msgid = %d\n"</span>, msgid);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// init sendbuf</span></span><br><span class="line">    sendbuf.type = <span class="number">100</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"please input message:\n"</span>);</span><br><span class="line">    fgets(sendbuf.voltage, <span class="number">124</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// start write message to message queue</span></span><br><span class="line">    msgsnd(msgid, (<span class="keyword">void</span> *)&amp;sendbuf, <span class="built_in">strlen</span>(sendbuf.voltage), <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// start read message from message queue</span></span><br><span class="line">    <span class="built_in">memset</span>(recvbuf.voltage, <span class="number">0</span>, <span class="number">124</span>);</span><br><span class="line">    readret = msgrcv(msgid, (<span class="keyword">void</span> *)&amp;recvbuf, <span class="number">124</span>, <span class="number">100</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"recv: %s, readret = %d\n"</span>, recvbuf.voltage, readret);</span><br><span class="line">    <span class="comment">// 第二次读</span></span><br><span class="line">    <span class="comment">// msgrcv(msgid, (void *)&amp;recvbuf, 124, 100, 0);</span></span><br><span class="line">    <span class="comment">// printf("recv: %s\n", recvbuf.voltage);</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// delete message queue </span></span><br><span class="line">    msgctl(msgid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>程序运行，键盘写入消息，然后在读取消息打印输出</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgrcv_01.png" style="zoom:80%"><p>如果两次读取则会发生错误，程序或阻塞，因为读取后消息被删除，读函数阻塞等待</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgrcv_02.png" style="zoom:80%"><h4 id="7-5-单向读写操作"><a class="header-anchor" href="#7-5-单向读写操作">¶</a>7.5 单向读写操作</h4><p><strong><code>write.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/msg.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> type;</span><br><span class="line">    <span class="keyword">char</span> voltage[<span class="number">124</span>];</span><br><span class="line">    <span class="keyword">char</span> ID[<span class="number">4</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msgid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">sendbuf</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">recvbuf</span>;</span></span><br><span class="line">    <span class="keyword">int</span> readret;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    key = ftok(<span class="string">"./a.c"</span>, <span class="string">'c'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"creat key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    msgid = msgget(key,IPC_CREAT | <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (msgid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create message queue failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create message queue success, msgid = %d\n"</span>, msgid);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    sendbuf.type = <span class="number">100</span>;</span><br><span class="line">    <span class="comment">// write message queue</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// init sendbuf</span></span><br><span class="line">        <span class="built_in">memset</span>(sendbuf.voltage, <span class="number">0</span>, <span class="number">124</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"please input message:\n"</span>);</span><br><span class="line">        fgets(sendbuf.voltage, <span class="number">124</span>, <span class="built_in">stdin</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// start write message to message queue</span></span><br><span class="line">    	msgsnd(msgid, (<span class="keyword">void</span> *)&amp;sendbuf, <span class="built_in">strlen</span>(sendbuf.voltage), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// delete message queue </span></span><br><span class="line">    msgctl(msgid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>read.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/msg.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> type;</span><br><span class="line">    <span class="keyword">char</span> voltage[<span class="number">124</span>];</span><br><span class="line">    <span class="keyword">char</span> ID[<span class="number">4</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msgid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">sendbuf</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">recvbuf</span>;</span></span><br><span class="line">    <span class="keyword">int</span> readret;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    key = ftok(<span class="string">"./a.c"</span>, <span class="string">'c'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"creat key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    msgid = msgget(key,IPC_CREAT | <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (msgid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create message queue failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create message queue success, msgid = %d\n"</span>, msgid);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// read message queue</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// init recvbuf</span></span><br><span class="line">        <span class="built_in">memset</span>(recvbuf.voltage, <span class="number">0</span>, <span class="number">124</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// start read message to message queue</span></span><br><span class="line">    	msgrcv(msgid, (<span class="keyword">void</span> *)&amp;recvbuf, <span class="number">124</span>, <span class="number">100</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"receive data from message queue: %s\n"</span>, recvbuf.voltage);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// delete message queue </span></span><br><span class="line">    msgctl(msgid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>程序运行后，<strong><code>write.c</code></strong> 写消息，<strong><code>read.c</code></strong> 读消息 (该例子与上一章最后一个例子相似)</p><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgwrite_01.png" alt="msgwrite_01"></p><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgread_01.png" alt></p><h4 id="7-6-双向通信"><a class="header-anchor" href="#7-6-双向通信">¶</a>7.6 双向通信</h4><p><strong><code>server.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/msg.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> type;</span><br><span class="line">    <span class="keyword">char</span> voltage[<span class="number">124</span>];</span><br><span class="line">    <span class="keyword">char</span> ID[<span class="number">4</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msgid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">sendbuf</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">recvbuf</span>;</span></span><br><span class="line">    <span class="keyword">int</span> readret;</span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    key = ftok(<span class="string">"./b.c"</span>, <span class="string">'c'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"creat key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    msgid = msgget(key,IPC_CREAT | <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (msgid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create message queue failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create message queue success, msgid = %d\n"</span>, msgid);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在消息队列创建之后，使用 fork 函数</span></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="comment">// parent process write type:100 Data</span></span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        sendbuf.type = <span class="number">100</span>;</span><br><span class="line">    	<span class="comment">// write message queue</span></span><br><span class="line">   		<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        	<span class="comment">// init sendbuf</span></span><br><span class="line">        	<span class="built_in">memset</span>(sendbuf.voltage, <span class="number">0</span>, <span class="number">124</span>);</span><br><span class="line">        </span><br><span class="line">        	<span class="built_in">printf</span>(<span class="string">"please input message:\n"</span>);</span><br><span class="line">        	fgets(sendbuf.voltage, <span class="number">124</span>, <span class="built_in">stdin</span>);</span><br><span class="line">        </span><br><span class="line">        	<span class="comment">// start write message to message queue</span></span><br><span class="line">    		msgsnd(msgid, (<span class="keyword">void</span> *)&amp;sendbuf, <span class="built_in">strlen</span>(sendbuf.voltage), <span class="number">0</span>);</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// child process read type:200 Data</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        	<span class="built_in">memset</span>(recvbuf.voltage, <span class="number">0</span>, <span class="number">124</span>);</span><br><span class="line">       	 	msgrcv(msgid, (<span class="keyword">void</span> *)&amp;recvbuf, <span class="number">124</span>, <span class="number">200</span>, <span class="number">0</span>);</span><br><span class="line">        	<span class="built_in">printf</span>(<span class="string">"receive from message queue: %s\n"</span>, recvbuf.voltage); </span><br><span class="line">            <span class="comment">// 可以打印输出后，当前行仍然提示可以输入数据，而不是没有提示</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"please input message:\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// delete message queue </span></span><br><span class="line">    msgctl(msgid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>client.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/msg.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"string.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> type;</span><br><span class="line">    <span class="keyword">char</span> voltage[<span class="number">124</span>];</span><br><span class="line">    <span class="keyword">char</span> ID[<span class="number">4</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msgid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">sendbuf</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">recvbuf</span>;</span></span><br><span class="line">    <span class="keyword">int</span> readret;</span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    key = ftok(<span class="string">"./b.c"</span>, <span class="string">'c'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"creat key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    msgid = msgget(key,IPC_CREAT | <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (msgid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create message queue failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create message queue success, msgid = %d\n"</span>, msgid);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">       </span><br><span class="line">    <span class="comment">// 在消息队列创建之后，使用 fork 函数</span></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="comment">// parent process read type:100 Data</span></span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">          	<span class="built_in">memset</span>(recvbuf.voltage, <span class="number">0</span>, <span class="number">124</span>);</span><br><span class="line">        	msgrcv(msgid, (<span class="keyword">void</span> *)&amp;recvbuf, <span class="number">124</span>, <span class="number">100</span>, <span class="number">0</span>);</span><br><span class="line">        	<span class="built_in">printf</span>(<span class="string">"receive data from message queue: %s\n"</span>, recvbuf.voltage); </span><br><span class="line">            <span class="comment">// 可以打印输出后，当前行仍然提示可以输入数据，而不是没有提示</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"please input message:\n"</span>);</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// child process write type:200 Data</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        sendbuf.type = <span class="number">200</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">memset</span>(sendbuf.voltage, <span class="number">0</span>, <span class="number">124</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"please input message:\n"</span>);</span><br><span class="line">            fgets(sendbuf.voltage, <span class="number">124</span>, <span class="built_in">stdin</span>);</span><br><span class="line">            msgsnd(msgid, (<span class="keyword">void</span> *)&amp;sendbuf, <span class="built_in">strlen</span>(sendbuf.voltage), <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// delete message queue </span></span><br><span class="line">    msgctl(msgid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">    system(<span class="string">"ipcs -q"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行程序：<strong><code>server</code></strong>，<strong><code>client</code></strong> 可以实现双方同时通信，皆可以收发</p><p>测试如下，双方交替通信三次。</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgserver.png" style="zoom:80%"> <img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/msgclient.png" style="zoom:80%"><h3 id="八、信号灯"><a class="header-anchor" href="#八、信号灯">¶</a>八、信号灯</h3><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/信号灯结构.png" style="zoom:67%"><p>所有函数是对一个集合的操作：</p><h4 id="8-1-创建和打开信号灯"><a class="header-anchor" href="#8-1-创建和打开信号灯">¶</a>8.1 创建和打开信号灯</h4><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semget函数.png" style="zoom:67%"><p><strong><code>semget.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/sem.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> semid;</span><br><span class="line">    semid = semget(IPC_PRIVATE, <span class="number">3</span>, <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (semid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create semaphore failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create semaphore success, semid = %d\n"</span>, semid);</span><br><span class="line">    system(<span class="string">"ipcs -s"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由内核给我们创建拥有三个信号量，权限是 777 的信号灯，因为使用 <strong><code>IPC_PRIVATE</code></strong> key，所以键值是 0</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semget_01.png" style="zoom:80%"><h4 id="8-2-信号灯的控制"><a class="header-anchor" href="#8-2-信号灯的控制">¶</a>8.2 信号灯的控制</h4><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semctl函数.png" style="zoom:67%"> <img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semctl_setval.png" style="zoom:67%"><p><strong><code>semctl.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/types.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/sem.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"signal.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"unistd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> semid;</span><br><span class="line">    semid = semget(IPC_PRIVATE, <span class="number">3</span>, <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (semid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create semaphore failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create semaphore success, semid = %d\n"</span>, semid);</span><br><span class="line">    system(<span class="string">"ipcs -s"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// delete semaphore</span></span><br><span class="line">    semctl(semid, <span class="number">0</span>, IPC_RMID);</span><br><span class="line">    system(<span class="string">"ipcs -s"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以发现被创建的 <strong><code>semid = 4</code></strong> 的信号灯被删除</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semctl.png" style="zoom:80%"><h4 id="8-3-线程同步"><a class="header-anchor" href="#8-3-线程同步">¶</a>8.3 线程同步</h4><h5 id="8-3-1-posix-实现方法"><a class="header-anchor" href="#8-3-1-posix-实现方法">¶</a>8.3.1 posix 实现方法</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pthread.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// child thread code</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">fun</span><span class="params">(<span class="keyword">char</span>* var)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;  <span class="comment">// second</span></span><br><span class="line">        usleep(<span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"this is fun j = %d\n"</span>, j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// main thread code</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str[] = <span class="string">"hello linux\n"</span>;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, fun, (<span class="keyword">void</span> *)str);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create thread failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123; <span class="comment">// first</span></span><br><span class="line">        usleep(<span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"this is main fun, i = %d\n"</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译：<strong><code>gcc -o posix posix.c -lpthread</code></strong></p><p>因为没有加 <strong><code>PV</code></strong> 操作，所以每次程序进行的顺序都是乱的。</p><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/posix_01.png" style="zoom:67%"><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/posix_02.png" style="zoom:67%"></p><p>使用 posix 信号量来实现两个线程之间的同步</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pthread.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"semaphore.h"</span></span></span><br><span class="line"><span class="comment">// 定义信号量</span></span><br><span class="line"><span class="keyword">sem_t</span> sem;</span><br><span class="line"></span><br><span class="line"><span class="comment">// child thread code</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">fun</span><span class="params">(<span class="keyword">char</span>* var)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    <span class="comment">// p wait</span></span><br><span class="line">    sem_wait(&amp;sem);</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;  <span class="comment">// second</span></span><br><span class="line">        usleep(<span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"this is fun j = %d\n"</span>, j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// main thread code</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str[] = <span class="string">"hello linux\n"</span>;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    sem_init(&amp;sem, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// sem = 0;</span></span><br><span class="line">    ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, fun, (<span class="keyword">void</span> *)str);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create thread failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123; <span class="comment">// first</span></span><br><span class="line">        usleep(<span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"this is main fun, i = %d\n"</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// v</span></span><br><span class="line">    sem_post(&amp;sem);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过使用信号量，可以实现线程之间的同步，主线程完成后子线程操作</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/posix_03.png" style="zoom:80%"><h5 id="8-3-2-信号灯实现方法"><a class="header-anchor" href="#8-3-2-信号灯实现方法">¶</a>8.3.2 信号灯实现方法</h5><p>**<code>semop</code>**函数</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semop函数1.png" style="zoom:67%"> <img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/semop函数2.png" style="zoom:67%"><p><strong><code>sem.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pthread.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/ipc.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/sem.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义信号量</span></span><br><span class="line"><span class="comment">// sem_t sem;</span></span><br><span class="line"><span class="comment">// 定于信号灯联合体</span></span><br><span class="line"><span class="keyword">union</span> semun &#123;</span><br><span class="line">    <span class="keyword">int</span>              val;    <span class="comment">/* Value for SETVAL */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> *<span class="title">buf</span>;</span>    <span class="comment">/* Buffer for IPC_STAT, IPC_SET */</span></span><br><span class="line">    <span class="keyword">unsigned</span> short  *<span class="built_in">array</span>;  <span class="comment">/* Array for GETALL, SETALL */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span>  *__<span class="title">buf</span>;</span>  <span class="comment">/* Buffer for IPC_INFO (Linux-specific) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> semid;</span><br><span class="line"><span class="keyword">union</span> semun mysemun;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">mysembuf</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// child thread code</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">fun</span><span class="params">(<span class="keyword">char</span>* var)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    <span class="comment">// p wait</span></span><br><span class="line">    <span class="comment">// sem_wait(&amp;sem);</span></span><br><span class="line">    mysembuf.sem_op = <span class="number">-1</span>;</span><br><span class="line">    semop(semid, &amp;mysembuf, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;  <span class="comment">// second</span></span><br><span class="line">        usleep(<span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"this is fun j = %d\n"</span>, j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// main thread code</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str[] = <span class="string">"hello linux\n"</span>;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="comment">// 创建信号灯</span></span><br><span class="line">    semid = semget(IPC_PRIVATE, <span class="number">3</span>, <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (semid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create semaphore failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create semaphore success\n"</span>);</span><br><span class="line">    system(<span class="string">"ipcs -s"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sem_init(&amp;sem, 0, 0); // sem = 0;</span></span><br><span class="line">    <span class="comment">// 信号量的初始化</span></span><br><span class="line">    mysemun.val = <span class="number">0</span>;</span><br><span class="line">    semctl(semid, <span class="number">0</span>, SETVAL, mysemun);</span><br><span class="line">    mysembuf.sem_num = <span class="number">0</span>;</span><br><span class="line">    mysembuf.sem_flg = <span class="number">0</span>; <span class="comment">// 阻塞操作</span></span><br><span class="line">    </span><br><span class="line">    ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, fun, (<span class="keyword">void</span> *)str);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create thread failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123; <span class="comment">// first</span></span><br><span class="line">        usleep(<span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"this is main fun, i = %d\n"</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// v</span></span><br><span class="line">    <span class="comment">// sem_post(&amp;sem);</span></span><br><span class="line">    mysembuf.sem_op = <span class="number">1</span>;</span><br><span class="line">    semop(semid, &amp;mysembuf, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现结果与 posix 实现方法相同</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/sem_posix.png" style="zoom:80%"><h4 id="8-4-进程同步"><a class="header-anchor" href="#8-4-进程同步">¶</a>8.4 进程同步</h4><p><strong><code>server.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pthread.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/ipc.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/sem.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义信号量</span></span><br><span class="line"><span class="comment">// sem_t sem;</span></span><br><span class="line"><span class="comment">// 定于信号灯联合体</span></span><br><span class="line"><span class="keyword">union</span> semun &#123;</span><br><span class="line">    <span class="keyword">int</span>              val;    <span class="comment">/* Value for SETVAL */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> *<span class="title">buf</span>;</span>    <span class="comment">/* Buffer for IPC_STAT, IPC_SET */</span></span><br><span class="line">    <span class="keyword">unsigned</span> short  *<span class="built_in">array</span>;  <span class="comment">/* Array for GETALL, SETALL */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span>  *__<span class="title">buf</span>;</span>  <span class="comment">/* Buffer for IPC_INFO (Linux-specific) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> semid;</span><br><span class="line"><span class="keyword">union</span> semun mysemun;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">mysembuf</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// main thread code</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建 key</span></span><br><span class="line">	<span class="keyword">int</span> key;</span><br><span class="line">    key = ftok(<span class="string">"./a.c"</span>, <span class="string">'a'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create key success\n"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建信号灯</span></span><br><span class="line">    semid = semget(key, <span class="number">3</span>, IPC_CREAT | <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (semid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create semaphore failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create semaphore success, semid = %d\n"</span>, semid);</span><br><span class="line">    system(<span class="string">"ipcs -s"</span>);</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 初始化信号  让client先运行，让client完成初始化即可，client 会使用 P 操作</span></span><br><span class="line">    <span class="comment">// mysemun.val = 0;</span></span><br><span class="line">    <span class="comment">// semctl(semid, 0, SETVAL, mysemun);</span></span><br><span class="line">    mysembuf.sem_num = <span class="number">0</span>;</span><br><span class="line">    mysembuf.sem_flg = <span class="number">0</span>; <span class="comment">// 阻塞操作</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123; <span class="comment">// first</span></span><br><span class="line">        usleep(<span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"server fun, i = %d\n"</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// v</span></span><br><span class="line">    mysembuf.sem_op = <span class="number">1</span>;</span><br><span class="line">    semop(semid, &amp;mysembuf, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>client.c</code></strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pthread.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/ipc.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys/sem.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义信号量</span></span><br><span class="line"><span class="comment">// sem_t sem;</span></span><br><span class="line"><span class="comment">// 定于信号灯联合体</span></span><br><span class="line"><span class="keyword">union</span> semun &#123;</span><br><span class="line">    <span class="keyword">int</span>              val;    <span class="comment">/* Value for SETVAL */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> *<span class="title">buf</span>;</span>    <span class="comment">/* Buffer for IPC_STAT, IPC_SET */</span></span><br><span class="line">    <span class="keyword">unsigned</span> short  *<span class="built_in">array</span>;  <span class="comment">/* Array for GETALL, SETALL */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span>  *__<span class="title">buf</span>;</span>  <span class="comment">/* Buffer for IPC_INFO (Linux-specific) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> semid;</span><br><span class="line"><span class="keyword">union</span> semun mysemun;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">mysembuf</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// main thread code</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建 key</span></span><br><span class="line">	<span class="keyword">int</span> key;</span><br><span class="line">    key = ftok(<span class="string">"./a.c"</span>, <span class="string">'a'</span>);</span><br><span class="line">    <span class="keyword">if</span> (key &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create key failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create key success\n"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建信号灯</span></span><br><span class="line">    semid = semget(key, <span class="number">3</span>, IPC_CREATE | <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span> (semid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"create semaphore failure\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"create semaphore success, semid = %d\n"</span>, semid);</span><br><span class="line">    system(<span class="string">"ipcs -s"</span>);</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 初始化信号</span></span><br><span class="line">    mysemun.val = <span class="number">0</span>;</span><br><span class="line">    semctl(semid, <span class="number">0</span>, SETVAL, mysemun);</span><br><span class="line">    mysembuf.sem_num = <span class="number">0</span>;</span><br><span class="line">    mysembuf.sem_flg = <span class="number">0</span>; <span class="comment">// 阻塞操作</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// P</span></span><br><span class="line">    mysembuf.sem_op = <span class="number">-1</span>;</span><br><span class="line">    semop(semid, &amp;mysembuf, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123; <span class="comment">// first</span></span><br><span class="line">        usleep(<span class="number">100</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"client fun, i = %d\n"</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>两个进程之间的逻辑如下：</p><p>首先打开 <strong><code>client</code></strong> 进程，创建信号灯，初始化信号灯，之后 P 操作，处于阻塞状态</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/sem_pv01.png" style="zoom:80%"><p>打开 <strong><code>server</code></strong> 进程，打开信号灯，执行程序代码，打印输出，睡眠 3 秒后，执行 V 操作</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/sem_pv02.png" style="zoom:80%"><p><strong><code>client</code></strong> 执行 P 操作之后的代码，打印输出</p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/sem_pv03.png" style="zoom:80%"><h3 id="函数分布图："><a class="header-anchor" href="#函数分布图：">¶</a>函数分布图：</h3><p><img src="/Server_Programming/Linux%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/IPC%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt></p><h3 id="参考资料："><a class="header-anchor" href="#参考资料：">¶</a>参考资料：</h3><blockquote><p><a href="https://www.bilibili.com/video/BV1tJ41117ty?p=1" target="_blank" rel="noopener">linux进程间通信_哔哩哔哩 (゜-゜)つロ 干杯~-bilibili</a></p></blockquote></div><div><div><br><br><div style="text-align:center;color:#ccc;font-size:14px">----------- 本文结束 -----------</div><br><br><br><br></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Server-Programming/" rel="tag"><i class="fa fa-tag">Server_Programming</i></a> <a href="/tags/Inter-Process-Communication/" rel="tag"><i class="fa fa-tag">Inter-Process Communication</i></a></div><div class="post-widgets"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/Database/MySQL%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" rel="next" title="MySQL常用命令"><i class="fa fa-chevron-left"></i> MySQL常用命令</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/Complie_and_Debug/makefile%E6%A0%BC%E5%BC%8F/" rel="prev" title="makefile 格式">makefile 格式 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/"><img class="site-author-image" itemprop="image" src="/images/logo.jpg" alt="从之丶"></a><p class="site-author-name" itemprop="name">从之丶</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">40</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">33</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/czGitAccount" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:caoz326@163.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-history fa-" aria-hidden="true"></i> 近期文章</div><ul class="links-of-blogroll-list"><li class="recent_posts_li"><a href="/Server_Programming/SimpleWebServer/" title="SimpleWebServer" target="_blank">SimpleWebServer</a></li><li class="recent_posts_li"><a href="/Data_Structure_and_Algorithm/%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98/" title="背包问题" target="_blank">背包问题</a></li><li class="recent_posts_li"><a href="/Database/Skiplist-CPP/" title="基于跳表实现的键值型存储引擎" target="_blank">基于跳表实现的键值型存储引擎</a></li><li class="recent_posts_li"><a href="/Database/Redis/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/" title="Redis数据结构与对象" target="_blank">Redis数据结构与对象</a></li><li class="recent_posts_li"><a href="/Server_Programming/Linux%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8Bexamples/" title="《Linux 高性能服务器编程》 实践" target="_blank">《Linux 高性能服务器编程》 实践</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#一、进程通信概述"><span class="nav-text">一、进程通信概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-进程通信、线程通信"><span class="nav-text">1. 进程通信、线程通信</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-进程通信方式"><span class="nav-text">2. 进程通信方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-进程通信的学习思路"><span class="nav-text">3. 进程通信的学习思路</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二、无名管道"><span class="nav-text">二、无名管道</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-无名管道的创建"><span class="nav-text">2.1 无名管道的创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-pipe-函数使用"><span class="nav-text">2.2 pipe 函数使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-验证读阻塞"><span class="nav-text">2.3 验证读阻塞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-验证写阻塞"><span class="nav-text">2.4 验证写阻塞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-实现进程通信。"><span class="nav-text">2.5 实现进程通信。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三、有名管道"><span class="nav-text">三、有名管道</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-有名管道的创建"><span class="nav-text">3.1 有名管道的创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-通过管道实现无亲缘关系进程间通信"><span class="nav-text">3.2 通过管道实现无亲缘关系进程间通信</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四、信号通信"><span class="nav-text">四、信号通信</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-信号的发送（发送信号进程）"><span class="nav-text">4.1 信号的发送（发送信号进程）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-1-kill"><span class="nav-text">4.1.1 kill</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-2-raise"><span class="nav-text">4.1.2 raise</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-3-alarm"><span class="nav-text">4.1.3 alarm</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-信号的接收（接收信号进程）"><span class="nav-text">4.2 信号的接收（接收信号进程）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-信号的处理（接收信号进程）"><span class="nav-text">4.3 信号的处理（接收信号进程）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-1-自定义处理"><span class="nav-text">4.3.1 自定义处理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-2-SIG-IGN-SIG-DFL"><span class="nav-text">4.3.2 SIG_IGN , SIG_DFL</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-signal-处理进程间通信"><span class="nav-text">4.4 signal 处理进程间通信</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#五、IPC-通信"><span class="nav-text">五、IPC 通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#六、共享内存"><span class="nav-text">六、共享内存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-创建和打开共享内存"><span class="nav-text">6.1 创建和打开共享内存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-ftok-函数，创建-key-值"><span class="nav-text">6.2 ftok 函数，创建 key 值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-将共享内存映射到用户空间中"><span class="nav-text">6.3 将共享内存映射到用户空间中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-删除进程里的地址映射"><span class="nav-text">6.4 删除进程里的地址映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-5-shmctl：删除共享内存对象"><span class="nav-text">6.5 shmctl：删除共享内存对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-6-有亲缘关系的进程（IPC-PRIVATE）"><span class="nav-text">6.6 有亲缘关系的进程（IPC_PRIVATE）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-7-无亲缘关系的进程（key）"><span class="nav-text">6.7 无亲缘关系的进程（key）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#七、消息队列"><span class="nav-text">七、消息队列</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-消息队列的创建和打开"><span class="nav-text">7.1 消息队列的创建和打开</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-消息队列控制"><span class="nav-text">7.2 消息队列控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-消息发送"><span class="nav-text">7.3 消息发送</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-消息接收"><span class="nav-text">7.4 消息接收</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-单向读写操作"><span class="nav-text">7.5 单向读写操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-双向通信"><span class="nav-text">7.6 双向通信</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#八、信号灯"><span class="nav-text">八、信号灯</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-创建和打开信号灯"><span class="nav-text">8.1 创建和打开信号灯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-信号灯的控制"><span class="nav-text">8.2 信号灯的控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-线程同步"><span class="nav-text">8.3 线程同步</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-1-posix-实现方法"><span class="nav-text">8.3.1 posix 实现方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-2-信号灯实现方法"><span class="nav-text">8.3.2 信号灯实现方法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-进程同步"><span class="nav-text">8.4 进程同步</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#函数分布图："><span class="nav-text">函数分布图：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考资料："><span class="nav-text">参考资料：</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">从之丶</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><i id="darkmode" class="fa fa-lightbulb-o" aria-hidden="true"></i><script>var body=$("body"),darkmode=$("#darkmode");(matchMedia("(prefers-color-scheme: dark)").matches||"1"===localStorage.getItem("darkmode"))&&"1"!==localStorage.getItem("noDark")&&body.addClass("dark"),body.hasClass("dark")?darkmode.removeClass("fa-moon-o").addClass("fa-lightbulb-o"):darkmode.removeClass("fa-lightbulb-o").addClass("fa-moon-o"),darkmode.click(function(){body.hasClass("dark")?(darkmode.removeClass("fa-lightbulb-o").addClass("fa-moon-o"),body.removeClass("dark"),localStorage.setItem("darkmode","0"),localStorage.setItem("noDark","1")):(darkmode.removeClass("fa-moon-o").addClass("fa-lightbulb-o"),body.addClass("dark"),localStorage.setItem("darkmode","1"),localStorage.setItem("noDark","0"))})</script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/clipboard.min.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/highlight-wrap.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={},pbOptions.iconStyle="box",pbOptions.boxForm="horizontal",pbOptions.position="bottomCenter",pbOptions.networks="Weibo,Wechat,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={},flOptions.iconStyle="box",flOptions.boxForm="horizontal",flOptions.position="middleRight",flOptions.networks="Weibo,Wechat,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-float",flOptions)</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"left",width:200,height:270},mobile:{show:!1},log:!1})</script></body></html><!-- rebuild by neat -->